#!/bin/bash

# Git pre-commit hook for Android project
# Runs code quality checks on staged files only

set -e

echo "üîç Running pre-commit checks..."

# Get the root directory of the git repository
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Get list of staged files
STAGED_JAVA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.java$' || true)
STAGED_KOTLIN_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.kt$' || true)
STAGED_CODE_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(java|kt)$' || true)

# Flag to track if any check failed
CHECKS_FAILED=false

# Function to run a check and handle failures
run_check() {
    local check_name="$1"
    local script_path="$2"
    local files="$3"

    if [ -n "$files" ]; then
        echo "üìã Running $check_name..."
        if ! bash "$script_path" $files; then
            echo "‚ùå $check_name failed"
            CHECKS_FAILED=true
        else
            echo "‚úÖ $check_name passed"
        fi
    else
        echo "‚è≠Ô∏è  No files for $check_name"
    fi
}

# 1. Check for debug code in all staged code files
if [ -n "$STAGED_CODE_FILES" ]; then
    echo "üêõ Checking for debug code..."
    if ! bash "scripts/check-debug-code.sh" $STAGED_CODE_FILES; then
        echo "‚ùå Debug code check failed"
        CHECKS_FAILED=true
    else
        echo "‚úÖ Debug code check passed"
    fi
fi

# 2. Run Checkstyle on Java files
run_check "Checkstyle" "scripts/run-checkstyle.sh" "$STAGED_JAVA_FILES"

# 3. Run Kotlin Lint on Kotlin files
run_check "Kotlin Lint" "scripts/run-kotlin-lint.sh" "$STAGED_KOTLIN_FILES"

# 4. Run Android Lint on all code files
if [ -n "$STAGED_CODE_FILES" ]; then
    echo "üîç Running Android Lint..."
    if ! bash "scripts/run-android-lint.sh" $STAGED_CODE_FILES; then
        echo "‚ùå Android Lint failed"
        CHECKS_FAILED=true
    else
        echo "‚úÖ Android Lint passed"
    fi
fi

# Final result
if [ "$CHECKS_FAILED" = true ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed! Please fix the issues above before committing."
    echo ""
    exit 1
else
    echo ""
    echo "‚úÖ All pre-commit checks passed! Proceeding with commit..."
    echo ""
    exit 0
fi